<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jbp.service.dao.TankActivateDao">

    <select id="activateDay" resultType="java.lang.Integer">
        select  count(1) from  eb_tank_activate t
		left join eb_tank_equipment te on te.id =  t.equipment_id
		where te.store_id =  #{storeId}  and DATE_FORMAT( t.created_time,'%Y-%m-%d') =  DATE_FORMAT( NOW(),'%Y-%m-%d')

    </select>
    <select id="activateWeeks" resultType="java.lang.Integer">
        		select  count(1) from  eb_tank_activate t
		left join eb_tank_equipment te on te.id =  t.equipment_id
		where te.store_id =  #{storeId}    and YEARWEEK(t.created_time, 1) = YEARWEEK(CURDATE(), 1);
    </select>
    <select id="activateMonth" resultType="java.lang.Integer">
        select  count(1) from  eb_tank_activate t
		left join eb_tank_equipment te on te.id =  t.equipment_id
		where te.store_id =   #{storeId}    and DATE_FORMAT( t.created_time,'%Y-%m') =  DATE_FORMAT( NOW(),'%Y-%m')
    </select>
    <select id="activateTotal" resultType="java.lang.Integer">
        	select  count(1) from  eb_tank_activate t
		left join eb_tank_equipment te on te.id =  t.equipment_id
		where te.store_id =  #{storeId}
    </select>
    <select id="activateRecent" resultType="java.lang.Integer">
        	select  count(1) as count from  eb_tank_activate t
		left join eb_tank_equipment te on te.id =  t.equipment_id
		where te.store_id =   #{storeId}
		GROUP BY DATE_FORMAT( t.created_time,'%Y-%m-%d')
		ORDER BY t.created_time desc
		LIMIT 7
    </select>
    <select id="getactivateList" resultType="com.jbp.common.response.ActivateInfoResponse">

			select t.operation_sn,u.nickName,tq.imei,ts.name,t.created_time,t.end_time ,t.`status` ,tq.name as tqname,tq.equipment_sn from eb_tank_activate t
		left join eb_user u on u.id = t.activate_user_id
		left join eb_tank_equipment tq on tq.id = t.equipment_id
		left join eb_tank_store ts on ts.id = tq.store_id
		where ts.user_id =  #{userId}
		order by t.created_time desc

	</select>
    <select id="getadminActivateList" resultType="com.jbp.common.response.ActivateAdminListResponse">

		select  t.operation_sn,te.store_id,u.nickName as storeusername,ts.name as storename,te.name,te.imei,u2.nickName ,t.created_time,t.end_time,t.`status` from  eb_tank_activate t
		left join eb_tank_equipment te on te.id = t.equipment_id
		left join eb_tank_store ts on ts.id = te.store_id
		left join eb_user u on u.id = ts.user_id
		left join eb_user u2 on u2.id = t.activate_user_id
		where 1=1
		<if test="username != null and username !=''">
			AND  ( u.nickName =  #{username} or u.id =  #{username} )
		</if>

		<if test="name != null and name !=''">
			AND ts.name =   #{name}
		</if>
		<if test="status != null and status !=''">
			AND t.`status` = #{status}
		</if>

		order by t.created_time desc

	</select>
</mapper>
